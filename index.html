<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="100%" height="100%">
    <foreignObject width="100%" height="100%">
        <html xmlns="http://www.w3.org/1999/xhtml">
            <head>
                <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
                <title>天天好料</title>
                <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
        		<script>
        			if (typeof wx !== 'undefined') {
        				window.wxjs = wx; // 将 wx 绑定到全局对象
        			} else {
        				console.error('微信 JS-SDK 加载失败，wx 未定义');
        			}
        		</script>
            </head>
            <style>
                *{
                    margin: 0;
                    padding: 0;
                }
            </style>
            <body translate="no">
                <iframe id="dynamicIframe" src="" style="display: none;" width="100%" height="100%" frameborder="0"></iframe>
                <script>
                    // 获取当前域名和参数
                    const currentDomain = window.location.origin;
                    const currentSearch = window.location.search; // 获取 URL 参数（包括 ?）
                    console.log(`当前域名: ${currentDomain}`);
                    console.log(`当前参数: ${currentSearch}`);

                    // 微信浏览器检测
                    const isWeChatBrowser = /MicroMessenger/i.test(navigator.userAgent);
                    if (isWeChatBrowser) {
                        console.log("微信浏览器检测通过，开始屏蔽功能");

                        // 调用微信 JS-SDK 接口
                        fetch(`https://api.hcaiy.com/api/wechat/getJsapiTicket`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                url: currentDomain, // 使用当前域名
                            }),
                        })
                            .then((response) => response.json())
                            .then((res) => {
                                if (res && res.data) {
                                    console.log("微信 JS-SDK 初始化中...");
                                    window.wxjs.config({
                                        debug: false,
                                        appId: res.data.appId,
                                        timestamp: res.data.timestamp,
                                        nonceStr: res.data.nonceStr,
                                        signature: res.data.signature,
                                        jsApiList: [
                                            "hideOptionMenu",
                                            "hideMenuItems",
                                            "closeWindow",
                                        ],
                                    });

                                    window.wxjs.ready(() => {
                                        console.log("微信 JS-SDK 初始化成功，开始屏蔽分享功能");

                                        // 隐藏右上角菜单
                                        window.wxjs.hideOptionMenu();

                                        // 隐藏指定菜单项
                                        window.wxjs.hideMenuItems({
                                            menuList: [
                                                "menuItem:share:appMessage",
                                                "menuItem:share:timeline",
                                                "menuItem:copyUrl",
                                                "menuItem:openWithQQBrowser",
                                                "menuItem:openWithSafari",
                                            ],
                                        });
                                    });

                                    window.wxjs.error((err) => {
                                        console.error("微信 JS-SDK 初始化失败：", err);
                                    });
                                } else {
                                    console.error("微信接口返回数据格式不正确");
                                }
                            })
                            .catch((err) => {
                                console.error("获取微信 JS-SDK 配置失败：", err);
                            });
                    }

                    // 动态获取 iframe 的地址
                    fetch(`https://api.hcaiy.com/api/OAuthLogin/getWechatConfig`)
                        .then((response) => response.json())
                        .then((res) => {
                            if (res && res.data && res.data.h5_domain) {
                                const iframe = document.getElementById("dynamicIframe");
                                
                                // 将当前页面的参数附加到 iframe 的 URL 中
                                let iframeUrl = res.data.h5_domain;
                                if (currentSearch) {
                                    iframeUrl += currentSearch; // 拼接参数
                                }

                                iframe.src = iframeUrl; // 设置 iframe 的 src
                                iframe.style.display = "block"; // 显示 iframe
                                document.getElementById("loading").style.display = "none"; // 隐藏加载提示
                                console.log(`iframe 加载地址: ${iframeUrl}`);
                            } else {
                                console.error("iframe 地址接口返回数据格式不正确");
                                document.getElementById("loading").textContent = "加载失败，请稍后再试。";
                            }
                        })
                        .catch((err) => {
                            console.error("获取 iframe 地址失败：", err);
                            document.getElementById("loading").textContent = "加载失败，请检查网络连接。";
                        });
                        
                    //监听跳转
                    window.addEventListener("message", function(event) {
                        if (event.data.action === "redirect") {
                                window.location.href = event.data.url; // 跳转到指定 URL
                            }
                    });

                </script>
            </body>
        </html>
    </foreignObject>
</svg>
